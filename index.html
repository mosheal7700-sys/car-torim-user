<!DOCTYPE html>
<html lang="he" dir="rtl">

<script>
// --- ×”×’×“×¨×” ×’×œ×•×‘×œ×™×ª: ×¤×•× ×§×¦×™×” ×œ××¡×š ××œ× ---
window.toggleFullScreen = function() {
  var doc = window.document;
  var docEl = doc.documentElement;
  
  var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
  var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
  var isFullScreen = doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement;
  
  if (!isFullScreen) {
    if (requestFullScreen) {
      requestFullScreen.call(docEl).catch(err => console.log("Error expanding:", err));
    } else {
      alert("××›×©×™×¨ ×–×” ××™× ×• ×ª×•××š ×‘×›×¤×ª×•×¨ ×”×¨×—×‘×”. × ×¡×” ×“×¨×š ×ª×¤×¨×™×˜ ×”×“×¤×“×¤×Ÿ.");
    }
  } else {
    if (cancelFullScreen) {
      cancelFullScreen.call(doc);
    }
  }
};

// --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---

let deferredPrompt;
const installBtn = document.getElementById('installUserBtn');

// ×‘×“×™×§×” ×”×× ×”××›×©×™×¨ ×”×•× ××™×™×¤×•×Ÿ (×›×™ ×‘××™×™×¤×•×Ÿ ×”××™×¨×•×¢ ×”××•×˜×•××˜×™ ×œ× ×§×™×™×, ×•×—×™×™×‘×™× ×œ×”×¦×™×’ ×›×¤×ª×•×¨ ×œ×”×¡×‘×¨)
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

// --- ×œ×•×’×™×§×” ×œ×”×¦×’×ª ×”×›×¤×ª×•×¨ ---

// 1. ×× ×–×” ××™×™×¤×•×Ÿ ×•×¢×“×™×™×Ÿ ×œ× ×”×ª×§× ×• - × ×¦×™×’ ××ª ×”×›×¤×ª×•×¨ ×‘×›×œ ××§×¨×” (×‘×©×‘×™×œ ×”×”×•×¨××•×ª)
if (isIOS && !isStandalone) {
  if (installBtn) installBtn.style.display = 'flex'; // ××• inline-block ×œ×¤×™ ×”×¢×™×¦×•×‘ ×©×œ×š
}

// 2. ×‘×× ×“×¨×•××™×“/××—×©×‘: × ×—×›×” ×©×”×“×¤×“×¤×Ÿ ×™×’×™×“ ×©×™×© ××¤×©×¨×•×ª ×œ×”×ª×§×™×Ÿ
window.addEventListener('beforeinstallprompt', (e) => {
  // ××•× ×¢ ××ª ×”×§×¤×¦×ª ×”×”×•×“×¢×” ×”××•×˜×•××˜×™×ª ×”××›×•×¢×¨×ª ×©×œ ×”×“×¤×“×¤×Ÿ
  e.preventDefault();
  deferredPrompt = e;
  console.log("Install prompt ready");
  
  // ×¨×§ ×¢×›×©×™×• - ×›×©×× ×—× ×• ×™×•×“×¢×™× ×©××¤×©×¨ ×œ×”×ª×§×™×Ÿ - × ×¦×™×’ ××ª ×”×›×¤×ª×•×¨!
  if (installBtn) installBtn.style.display = 'flex';
});

// 3. ×”×¢×œ××ª ×”×›×¤×ª×•×¨ ×œ××—×¨ ×”×ª×§× ×” ××•×¦×œ×—×ª
window.addEventListener('appinstalled', () => {
  console.log('App installed successfully');
  if (installBtn) installBtn.style.display = 'none';
  deferredPrompt = null;
});

// --- ×”×¤×•× ×§×¦×™×” ×‘×œ×—×™×¦×” ---
window.installPWA = async function() {
  // ×”×ª×§× ×” ××•×˜×•××˜×™×ª (×× ×“×¨×•××™×“)
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log('User choice:', outcome);
    
    // ×× ×”××©×ª××© ×”×¡×›×™× - × ×¢×œ×™× ××™×“
    if (outcome === 'accepted') {
      if (installBtn) installBtn.style.display = 'none';
      deferredPrompt = null;
    }
  }
  // ×”×•×¨××•×ª ×™×“× ×™×•×ª (××™×™×¤×•×Ÿ ××• ×›×©××™×Ÿ ××™×¨×•×¢)
  else {
    const msg = isIOS
    ? "×‘××™×™×¤×•×Ÿ:\n×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×©×™×ª×•×£ (×œ××˜×” ×‘×××¦×¢) \n×•×‘×—×¨ '×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª' (Add to Home Screen)."
    : "×”××¤×œ×™×§×¦×™×” ×›× ×¨××” ×›×‘×¨ ××•×ª×§× ×ª, ××• ×©×™×© ×œ×”×ª×§×™×Ÿ ×“×¨×š ×ª×¤×¨×™×˜ ×”×“×¤×“×¤×Ÿ (3 × ×§×•×“×•×ª > ×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª).";
    alert(msg);
  }
};

// --- ×©××¨ ×”×¤×•× ×§×¦×™×•×ª ×©×œ×š (××¡×š ××œ× ×•×›×•') ---
window.toggleFullScreen = function() {
  var doc = window.document;
  var docEl = doc.documentElement;
  var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
  var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
  var isFullScreen = doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement;
  
  if (!isFullScreen) {
    if (requestFullScreen) requestFullScreen.call(docEl);
  } else {
    if (cancelFullScreen) cancelFullScreen.call(doc);
  }
};

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(console.error);
}
</script>

<head>
<meta charset="UTF-8">
<title>×”×–×× ×ª ×ª×•×¨×™×</title>

<!-- ******×œ×™×¦×™×¨×ª ×§×™×©×•×¨ ×¢× ×ª××•× ×” ×‘×•×•×¦××¤, ×œ×”×›× ×™×¡ ×§×™×©×•×¨×™× ×××™×ª×™×™× ***-->
<meta property="og:title" content="×–×™××•×Ÿ ×ª×•×¨×™×">
<!--**** ×ª×™××•×¨ ×©×™×•×¤×™×¢ ×‘×œ×™× ×§ ×”×—×œ×¤×” ****-->
<meta property="og:description" content="×”×–××Ÿ ×ª×•×¨">
<meta property="og:type" content="website">
<!--******************************************** ×”×—×œ×¤×” ***************************************-->
<meta property="og:url" content="https://my-torim-app.netlify.app/" />
<meta property="og:image" content="https://my-torim-app.netlify.app/icon2.png" />
<!-- ******×œ×™×¦×™×¨×ª ×§×™×©×•×¨ ×¢× ×ª××•× ×” ×‘×•×•×¦××¤, ×œ×”×›× ×™×¡ ×§×™×©×•×¨×™× ×××™×ª×™×™× ***-->
<!--******************************************** ×”×—×œ×¤×” ***************************************-->

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="./manifest_user.json">
<meta name="theme-color" content="#ffffff">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

<style>
/* --- ×”×’×“×¨×ª ××©×ª× ×™ ×¦×‘×¢×™× (×¢×™×¦×•×‘ ×ª×•×× ×œ×××©×§ × ×™×”×•×œ) --- */
:root {
  /* ×¤×œ×˜×ª ×¦×‘×¢×™× ××•×“×¨× ×™×ª (Slate Theme) */
  --bg-body: #0f172a;       /* ×›×—×•×œ ×œ×™×œ×” ×¢××•×§ - ×¨×§×¢ ×¨××©×™ */
  --bg-panel: #1e293b;      /* ×›×—×•×œ ×›×”×” - ×›×¨×˜×™×¡×™× ×•×¤×× ×œ×™× */
  --bg-input: #334155;      /* ×¨×§×¢ ×œ×©×“×•×ª ×§×œ×˜ ×•×›×¤×ª×•×¨×™× ×œ× ×¤×¢×™×œ×™× */
  --border-input: #475569;  /* ×’×‘×•×œ×•×ª ×¢×“×™× ×™× */
  
  --text-main: #f1f5f9;     /* ×œ×‘×Ÿ ×‘×•×”×§ ×œ×˜×§×¡×˜ ×¨××©×™ */
  --text-muted: #94a3b8;    /* ××¤×•×¨-×›×—×œ×—×œ ×œ×˜×§×¡×˜ ××©× ×™ */
  
  /* ×¦×‘×¢×™ ×¤×¢×•×œ×” */
  --accent-color: #38bdf8;  /* ×ª×›×œ×ª ×‘×”×™×¨ (×›××• ×‘×××©×§ × ×™×”×•×œ) */
  --accent-hover: #0ea5e9;  /* ×ª×›×œ×ª ×›×”×” ×™×•×ª×¨ ×œ××¢×‘×¨ ×¢×›×‘×¨ */
  
  /* ×¦×‘×¢×™ ×œ×•×— ×©× ×” */
  --day-bg: #1e293b;        /* ×¨×§×¢ ×™×•× ×¨×’×™×œ */
  --day-hover: #334155;     /* ×¨×§×¢ ×™×•× ×‘××¢×‘×¨ ×¢×›×‘×¨ */
  --day-disabled: #0f172a;  /* ×™××™× ×œ× ×¤×¢×™×œ×™× (××©×ª×œ×‘ ×¢× ×”×¨×§×¢) */
  
  /* ×›×•×ª×¨×•×ª (××™×¤×•×™ ×œ××©×ª× ×™× ×”×§×™×™××™× ×©×œ×š) */
  --title-color: #38bdf8;   /* ×ª×•×× ×œ×¦×‘×¢ ×”×“×’×©×” */
  --subtitle-color: #94a3b8; /* ×ª×•×× ×œ×˜×§×¡×˜ ××©× ×™ */
  
  /* ××œ×× ×˜×™× × ×•×¡×¤×™× */
  --modal-bg: #1e293b;
  --shadow-color: rgba(0, 0, 0, 0.5);
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
}

body
{
  background-color: var(--bg-body);
  color: var(--text-main);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 20px;
  direction: rtl;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 90vh;
}

/* ×¢×“×›×•×Ÿ ×§×˜×Ÿ ×œ×›×¨×˜×™×¡×™× ×©×™×™×¨××• ×˜×•×‘ ×™×•×ª×¨ ×¢× ×”×¦×‘×¢×™× ×”×—×“×©×™× */
.container, .modal-content {
  background-color: var(--bg-panel);
  border: 1px solid var(--border-input); /* ××¡×’×¨×ª ×¢×“×™× ×” */
  box-shadow: var(--shadow-card);
}

/* --- ×”×’×“×¨×•×ª ×œ××¦×‘ ×™×•× (Light Mode) --- */
body.light-mode {
  /* ×“×¨×™×¡×ª ×”××©×ª× ×™× ×œ×’×•×•× ×™× ×‘×”×™×¨×™× ×ª×•×××™× */
  --bg-body: #f1f5f9;       /* ×¨×§×¢ ×›×œ×œ×™ ×‘×”×™×¨ (Slate 100) */
  --bg-panel: #ffffff;      /* ×›×¨×˜×™×¡×™× ×‘×œ×‘×Ÿ × ×§×™ */
  --bg-input: #e2e8f0;      /* ×©×“×•×ª ×§×œ×˜ ××¤×•×¨-×‘×”×™×¨ */
  --border-input: #cbd5e1;  /* ××¡×’×¨×•×ª ××¤×•×¨×•×ª */
  
  --text-main: #0f172a;     /* ×˜×§×¡×˜ ×¨××©×™ ×›×”×” ×××•×“ */
  --text-muted: #64748b;    /* ×˜×§×¡×˜ ××©× ×™ ××¤×•×¨-×›×—×œ×—×œ */
  
  --accent-color: #0ea5e9;  /* ×ª×›×œ×ª ××¢×˜ ×›×”×” ×™×•×ª×¨ ×©×™×™×¨××” ×˜×•×‘ ×¢×œ ×œ×‘×Ÿ */
  --accent-hover: #0284c7;
  
  --day-bg: #ffffff;        /* ×™×•× ×‘×œ×•×— ×©× ×” - ×œ×‘×Ÿ */
  --day-hover: #f1f5f9;     /* ××¢×‘×¨ ×¢×›×‘×¨ - ××¤×•×¨ ×‘×”×™×¨ */
  --day-disabled: #e2e8f0;  /* ×™××™× ×œ× ×¤×¢×™×œ×™× */
  
  --modal-bg: #ffffff;
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.05);
}

/* ××¡×š ×˜×¢×™× ×” */
#loadingOverlay {
  position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
  color:white; display:none; justify-content:center; align-items:center; z-index:9999; font-size: 1.5em; flex-direction: column; text-align: center;
}
#loadingText { margin-bottom: 10px; }
#connectionStatus { font-size: 0.7em; color: #aaa; }
#retryBtn { margin-top: 20px; padding: 8px 15px; background: #4facfe; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; font-size: 0.8em; }

/* --- ×¢×™×¦×•×‘ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× (Modals) --- */
#successModal, #checkResultModal {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.85); z-index: 10000;
  display: none; justify-content: center; align-items: center;
}

.modal-content {
  background: var(--modal-bg); /* ××©×ª× ×” */
  color: var(--text-main);     /* ××©×ª× ×” */
  padding: 30px; border-radius: 16px; width: 90%; max-width: 380px; text-align: center;
  box-shadow: 0 10px 40px var(--shadow-color); border: 1px solid var(--border-input); position: relative;
}

.close-x { position: absolute; top: 10px; left: 15px; font-size: 2em; color: #888; cursor: pointer; transition: color 0.2s; line-height: 0.8; padding: 5px; }
.close-x:hover { color: var(--text-main); }
.modal-icon { font-size: 3.5em; margin-bottom: 10px; }
.modal-text { font-size: 1.1em; color: var(--text-muted); margin-bottom: 25px; line-height: 1.6; }
.modal-buttons { display: flex; flex-direction: column; gap: 15px; }

.btn-google { background: #4285F4; color: white; padding: 14px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; font-size: 1.1em; display: block; width: 100%; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; }
.btn-google:hover { background: #3367d6; transform: scale(1.02); }
.btn-ics { background: #555; color: #fff; padding: 14px; border-radius: 10px; border: 1px solid #777; font-weight: bold; cursor: pointer; font-size: 1.1em; display: block; width: 100%; transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
.btn-ics:hover { background: #666; }

/* ×›×¤×ª×•×¨ ×‘×™×˜×•×œ ×‘×ª×•×š ×”××•×“×œ */
.btn-cancel-appt { background: #dc3545; color: white; padding: 14px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; font-size: 1.1em; width: 100%; margin-top: 10px; }
.btn-cancel-appt:hover { background: #c82333; }

/* --- ××¡×š ×¡×™×•× (Post Booking) --- */
#postBookingScreen {
  display: none;
  flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; animation: fadeIn 0.5s;
}
.post-btn { width: 80%; max-width: 300px; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: transform 0.1s; }
.btn-return { background: #007bff; color: white; }
.btn-return:hover { background: #0056b3; }
.btn-exit { background: #444; color: #ccc; border: 1px solid #666; }
.btn-exit:hover { background: #555; color: white; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* ×›×•×ª×¨×•×ª */
h2 { color: var(--title-color); text-align: center; padding: 0; margin: 0; font-size: 1.8em; }
#pageSubtitle { text-align: center; color: var(--text-muted); font-size: 1.1em; margin-top: 5px; margin-bottom: 10px; font-weight: normal; min-height: 20px; }

#main-container { display: flex; flex-direction: row-reverse; max-width: 1250px; margin: 0 auto; gap: 10px; flex: 1; height: auto; min-height: 0; width: 100%; }

.panel {
  background: var(--bg-panel); /* ××©×ª× ×” */
  padding: 12px; border-radius: 12px;
  box-shadow: 0 4px 12px var(--shadow-color); /* ××©×ª× ×” */
  overflow-y: auto; height: 100%; box-sizing: border-box;
  transition: background 0.3s;
}

#calendarPanel { flex-basis: 340px; flex-shrink: 0; overflow-y: hidden; }
#slotsWrapper { flex-basis: 340px; flex-shrink: 0; display: flex; flex-direction: column; }
#form-and-check-wrapper { flex-grow: 1; display: flex; flex-direction: column; gap: 10px; height: 100%; }
#formPanel, #checkPanel { margin: 0; padding: 15px; flex-shrink: 0; overflow-y: visible; height: auto; }

#calendarHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 5px 0; }
#calendarHeader button { background: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-input); padding: 8px 12px; font-size: 1em; cursor: pointer; border-radius: 4px; }
#calendarHeader button:hover { background: var(--day-hover); }
#monthYearDisplay { color: var(--title-color); font-size: 1.3em; font-weight: bold; }

#weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: bold; margin-bottom: 5px; color: #aaa; font-size: 1em; }
#calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }

/* ×™××™ ×”×œ×•×— - ×¢×™×¦×•×‘ × ×§×™ ×œ×œ× ×¨×™×‘×•×¢×™× */
.day {
  text-align: center;
  cursor: pointer;
  background: transparent !important; /* ×‘×™×˜×•×œ ×”×¨×§×¢ ×”×¨×™×‘×•×¢×™ */
  color: var(--text-main);
  border: none !important;            /* ×‘×™×˜×•×œ ×”××¡×’×¨×•×ª ×”×¨×™×‘×•×¢×™×•×ª */
  font-size: 1em;
  font-weight: normal;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 35px; /* ×’×•×‘×” ×•×¨×•×—×‘ ×©×•×•×™× ×œ×™×¦×™×¨×ª ×¢×™×’×•×œ */
  width: 35px;
  margin: auto;
}

.day:hover {
  background: #334155 !important; /* ×¨×§×¢ ×¢×“×™×Ÿ ×‘××¢×‘×¨ ×¢×›×‘×¨ */
  border-radius: 50%;
}

/* ×”×ª××¨×™×š ×”× ×‘×—×¨ - ×¤×ª×¨×•×Ÿ ×œ×‘×¢×™×™×ª ×”× ×™×’×•×“×™×•×ª */
.day.selected-day {
  border: 2px solid #3b82f6 !important; /* ×›×—×•×œ ××™×ª×•×’×™ */
  border-radius: 50% !important;        /* ×”×¤×™×›×” ×œ×¢×™×’×•×œ */
  background-color: #739ad8 !important; /* ×¨×§×¢ ×›×—×•×œ ×‘×•×œ×˜ */
  color: #ffffff !important;            /* ×˜×§×¡×˜ ×œ×‘×Ÿ ×©×—×•×‘×” ×©×™×™×¨××” ×¢×œ ×›×—×•×œ */
  font-weight: bold !important;
  width: 35px;
  height: 35px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ×‘××™×“×” ×•××ª×” ×‘××¦×‘ ×‘×”×™×¨, ×•×•×“× ×©×”××¡×¤×¨ ×œ× ×”×•×¤×š ×œ×›×”×” ×‘×˜×¢×•×ª */
body.light-mode .day.selected-day {
  color: #ffffff !important; /* ×ª××™×“ ×œ×‘×Ÿ ×¢×œ ×”×¢×™×’×•×œ ×”×›×—×•×œ */
}

/* ×—×™×•×•×™ ×œ×ª×•×¨×™× ×¤× ×•×™×™× - ×§×• ×§×˜×Ÿ ××ª×—×ª ×œ××¡×¤×¨ */
.day.has-slots {
  border-bottom: 3px solid #10b981 !important; /* ×™×¨×•×§ ×¢×“×™×Ÿ */
  border-radius: 0;
}

.day.disabled, .day.past {
  opacity: 0.3;
  cursor: not-allowed;
}

#slotsWrapper h3 { color: var(--title-color); text-align: center; margin-top: 0; font-size: 1.4em; border-bottom: 1px dashed #555; padding-bottom: 5px; }
#slots-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding-top: 10px; }

/* ×”×¢×ª×§ ×•×”×—×œ×£ ××ª ×”×—×œ×§ ×©×œ .slot-btn ×‘×§×•×‘×¥ ×©×œ×š */
.slot-btn {
  background: #81a9dd; /* ×˜×•×¨×§×™×– ×¨×š */
  color: white;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1.1em;
  transition: background 0.2s, transform 0.1s;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.slot-btn:hover {
  background: #009688; /* ×˜×•×¨×§×™×– ×›×”×” ×™×•×ª×¨ */
  transform: translateY(-2px);
}
.slot-btn.selected { background: #007bff; border: 3px solid #fff; }
.slot-btn.disabled { background: #666; cursor: not-allowed; }

#formPanel h3 { color: var(--subtitle-color); font-size: 1.2em; text-align: center; margin-top: 0; margin-bottom: 10px; }
.input-group { margin-bottom: 10px; }
.input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 1em; }
.input-group input {
  width: 100%; padding: 8px; font-size: 0.95em; border-radius: 5px;
  border: 1px solid var(--border-input); /* ××©×ª× ×” */
  background: var(--bg-input);           /* ××©×ª× ×” */
  color: var(--text-main);               /* ××©×ª× ×” */
  box-sizing: border-box;
}

#checkPanel h3 { color: var(--accent-color); text-align: center; margin-top: 0; margin-bottom: 10px; }
#checkForm { display: flex; gap: 10px; align-items: center; }
#checkPhone { flex-grow: 1; width: 100%; padding: 10px; font-size: 1.1em; border-radius: 5px; border: 1px solid var(--border-input); background: var(--bg-input); color: var(--text-main); box-sizing: border-box; }
#checkBtn { padding: 10px 20px; background: var(--accent-color); color: #333; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }

@media (max-width: 1000px) {
  body { height: auto; overflow-y: auto; display: block; }
  #main-container { height: auto; display: flex; flex-direction: column; }
  .panel { flex-basis: auto; max-width: 100%; height: auto; overflow-y: visible; }
  #calendarPanel, #slotsWrapper { flex-basis: auto; max-width: 400px; margin: 0 auto; }
  #form-and-check-wrapper { flex-grow: 1; max-width: 100%; }
}

/* ×§×‘×•×¦×ª ×”×›×¤×ª×•×¨×™× - ×××§× ××•×ª× ××—×“ ×œ×™×“ ×”×©× ×™ */
.action-buttons-container { display: flex; gap: 10px; margin-top: 10px; }
/* ×¢×™×¦×•×‘ ××©×•×ª×£ ×œ×›×¤×ª×•×¨×™× */
#bookBtn, #swapBtn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; transition: background 0.2s, transform 0.1s; color: white; }
/* ×¦×‘×¢ ×›×¤×ª×•×¨ ××™×©×•×¨ ×¨×’×™×œ */
#bookBtn { background: #007bff; width: auto; }
#bookBtn:hover { background: #0056b3; }
/* ×¦×‘×¢ ×›×¤×ª×•×¨ ×”×—×œ×¤×” */
#swapBtn { background: #ff9800; }
#swapBtn:hover { background: #e68900; }
/* ××¦×‘ ××‘×•×˜×œ ×œ×©× ×™ ×”×›×¤×ª×•×¨×™× */
#bookBtn:disabled, #swapBtn:disabled { background: #6c757d; cursor: not-allowed; opacity: 0.7; }

/* ×”×¢×œ××ª ×”×—×™×¦×™× ×‘×©×“×” ××¡×¤×¨×™ (Chrome, Safari, Edge, Opera) */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* ×”×¢×œ××ª ×”×—×™×¦×™× ×‘×¤×™×™×¨×¤×•×§×¡ */
input[type=number] {
  -moz-appearance: textfield;
}

/* --- ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× ×¦×¤×™× (××¡×š ××œ× / ×”×ª×§× ×” / × ×•×©×) --- */
#floating-controls {
  position: fixed;
  top: 20px;
  left: 20px;            /* ×¤×™× ×” ×©×××œ×™×ª ×¢×œ×™×•× ×” - ×œ× ××¤×¨×™×¢ ×œ×¢×‘×¨×™×ª */
  z-index: 99999;        /* ×ª××™×“ ××¢×œ ×”×›×œ */
  display: flex;
  gap: 12px;             /* ×¨×•×•×— ×‘×™×Ÿ ×”×›×¤×ª×•×¨×™× */
  align-items: center;
  direction: ltr;        /* ×›×“×™ ×©×”×¡×“×¨ ×™×”×™×” ×§×‘×•×¢ ××©×××œ ×œ×™××™×Ÿ */
}

.float-btn {
  height: 42px;          /* ×’×•×‘×” ××—×™×“ ×•× ×•×— */
  background: var(--bg-panel);
  border: 1px solid var(--border-input);
  color: var(--text-main);
  border-radius: 50px;   /* ×¦×•×¨×” ×¢×’×•×œ×”/×§×¤×¡×•×œ×” */
  cursor: pointer;
  font-size: 1rem;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 16px;       /* ×¨×™×¤×•×“ ×¨×—×‘ */
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  transition: all 0.2s ease;
}

/* ×›×¤×ª×•×¨ ××¡×š ××œ× - ×ª××™×“ ×¢×’×•×œ */
#fullscreenBtn {
  width: 42px;           /* ×¨×•×—×‘ = ×’×•×‘×” */
  padding: 0;
  border-color: #75FBFD; /* ××¡×’×¨×ª ×˜×•×¨×§×™×– */
  color: #75FBFD;
}

/* ×›×¤×ª×•×¨ ×”×ª×§× ×” - ××™×•×—×“ */
#installAppBtn {
  background: rgba(117, 251, 253, 0.1);
  border-color: #75FBFD;
  color: #75FBFD;
  gap: 8px;
}

/* ×›×¤×ª×•×¨ ×™×•×/×œ×™×œ×” */
#themeBtn {
  gap: 8px;
  min-width: 42px;
}

.btn-icon {
  font-size: 1.2rem;
  line-height: 1;
}

/* ××¤×§×˜×™× ×‘××¢×‘×¨ ×¢×›×‘×¨ */
.float-btn:hover {
  transform: translateY(-2px);
  background: var(--bg-input);
}
#fullscreenBtn:hover, #installAppBtn:hover {
  box-shadow: 0 0 15px rgba(117, 251, 253, 0.3);
}

/* --- ×”×ª×××” ×œ× ×™×™×“ (Mobile) - ×”×•×¤×š ×œ××™×™×§×•× ×™× ×§×˜× ×™× --- */
/* --- ×”×ª×××” ×œ× ×™×™×“ (Mobile) - ×”×•×¤×š ×œ×¤×¡ ×¢×œ×™×•×Ÿ ×§×‘×•×¢ ×•×œ× ×¦×£ --- */
@media (max-width: 600px) {
  #floating-controls {
    position: relative; /* ğŸ‘ˆ ×”×©×™× ×•×™ ×”×—×©×•×‘: ×›×‘×¨ ×œ× ×¦×£, ××œ× ×—×œ×§ ××”×“×£ */
    top: auto;
    left: auto;
    width: 100%;       /* ×ª×•×¤×¡ ××ª ×›×œ ×”×¨×•×—×‘ */
    padding: 10px;     /* ×§×¦×ª ××¨×•×•×— */
    margin-bottom: 0;  /* × ×¦××“ ×œ×›×•×ª×¨×ª ×©××ª×—×ª×™×• */
    background: transparent; /* ××• ×¦×‘×¢ ×¨×§×¢ ×× ×ª×¨×¦×” */
    justify-content: flex-start; /* ××¦××™×“ ×œ×©×××œ (××• center ×œ××¨×›×–) */
  }
  
  .float-btn {
    height: 38px;      /* ×›×¤×ª×•×¨ ×§×˜×Ÿ ×™×•×ª×¨ */
    padding: 0;
    width: 38px;       /* ×¢×™×’×•×œ ××•×©×œ× */
    border-radius: 50%;
    justify-content: center;
  }
  
  /* ×”×¡×ª×¨×ª ×”×˜×§×¡×˜ ×‘×˜×œ×¤×•×Ÿ */
  .btn-text {
    display: none;
  }
  
  .btn-icon {
    margin: 0;
  }
  
}

/* --- ×©×™×¤×•×¨ ×¨×™×•×•×— ×œ××¡×›×™× ×’×“×•×œ×™× (×ª×™×§×•×Ÿ ×¡×•×¤×™) --- */

/* ×›×©×”××¡×š ×’×“×•×œ (××—×©×‘/×˜××‘×œ×˜) */
@media (min-width: 601px) {
  
  /* ×”×•×¡×¤×ª ×”×¨×•×•×— ×œ×ª×™×‘×” ×©×¢×•×˜×¤×ª ××ª ×©×ª×™ ×”×›×•×ª×¨×•×ª ×™×—×“ */
  #header-area {
    margin-bottom: 60px;  /* ×–×” ×“×•×—×£ ××ª ×›×œ ×”×¤× ×œ×™× ×œ××˜×” */
    transition: all 0.3s ease;
  }
  
  /* ×”×’×“×œ×ª ×”×›×•×ª×¨×ª ×”×¨××©×™×ª ×‘××—×©×‘ */
  h2 {
    font-size: 2.5rem;
  }
  
  /* ×”×’×“×œ×ª ×›×•×ª×¨×ª ×”××©× ×” ×‘××—×©×‘ */
  #pageSubtitle {
    font-size: 1.5rem;
    margin-top: 0;        /* ××•×•×“× ×©×”×™× × ×©××¨×ª ×¦××•×“×” ×œ×›×•×ª×¨×ª ×©××¢×œ×™×” */
  }
  
  /* ×¨×•×—×‘ ××§×¡×™××œ×™ ×œ×ª×•×›×Ÿ */
  #main-container {
    max-width: 1000px;
  }
}
</style>
</head>
<body>

<div id="floating-controls">

<button id="fullscreenBtn" class="float-btn" onclick="toggleFullScreen()" title="××¡×š ××œ×">
<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#75FBFD">
<path d="M792-576v-120H672v-72h120q30 0 51 21.15T864-696v120h-72Zm-696 0v-120q0-30 21.15-51T168-768h120v72H168v120H96Zm576 384v-72h120v-120h72v120q0 30-21.15 51T792-192H672Zm-504 0q-30 0-51-21.15T96-264v-120h72v120h120v72H168Zm72-144v-288h480v288H240Zm72-72h336v-144H312v144Zm0 0v-144 144Z"/>
</svg>
</button>

<button id="themeBtn" class="float-btn" onclick="toggleTheme()">
<span class="btn-icon">â˜€ï¸</span>
<span class="btn-text">×™×•×</span>
</button>

<!-- ******************×›×¤×ª×•×¨ ×”×ª×§× ×”***************
<button id="installUserBtn" class="float-btn" onclick="installPWA()" title="×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”">
<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#75FBFD">
<path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
</svg>
<span class="btn-text">×”×ª×§× ×”</span>
</button>
******************×›×¤×ª×•×¨ ×”×ª×§× ×”*************** -->

</div>
<div id="successModal">
<div class="modal-content">
<span class="close-x" onclick="closeSuccessModal()">&times;</span>
<div class="modal-icon">âœ…</div>
<h3 style="margin:0; color:#4CAF50;">×”×ª×•×¨ × ×§×‘×¢ ×‘×”×¦×œ×—×”!</h3>
<p id="successText" class="modal-text"></p>
<div class="modal-buttons">
<button id="btnGoogle" class="btn-google">ğŸ“… ×”×•×¡×£ ×œ×™×•××Ÿ Google</button>
<button id="btnIcs" class="btn-ics">ğŸ“‚ ×”×•×¨×“ ×§×•×‘×¥ ×™×•××Ÿ (Outlook/××—×¨)</button>
</div>
<div style="margin-top:15px; font-size:0.8em; color:#888;">×‘×—×¨ ××¤×©×¨×•×ª ××• ×¡×’×•×¨ ×‘-X</div>
</div>
</div>

<div id="checkResultModal">
<div class="modal-content">
<span class="close-x" onclick="document.getElementById('checkResultModal').style.display='none'">&times;</span>

<div id="checkModalIcon" class="modal-icon"></div>
<h3 id="checkModalTitle" style="margin:0;"></h3>
<p id="checkModalText" class="modal-text" style="margin-top:10px;"></p>

<div id="checkModalActions" class="modal-buttons">
</div>
</div>
</div>

<div id="loadingOverlay">
<div id="loadingText">××ª×—×‘×¨ ×œ××¢×¨×›×ª ×”×ª×•×¨×™×...</div>
<div id="connectionStatus">×™×•×¦×¨ ×—×™×‘×•×¨ ×××•×‘×˜×—</div>
<button id="retryBtn" onclick="location.reload()">× ×¡×” ×œ×˜×¢×•×Ÿ ××—×“×©</button>
</div>

<div id="header-area">
<h2 id="mainTitle">××¢×¨×›×ª ×œ×”×–×× ×ª ×ª×•×¨×™×</h2>
<h3 id="pageSubtitle"></h3>
</div>

<div id="main-container">
<div id="calendarPanel" class="panel">
<div id="calendarHeader">
<button onclick="prevMonth()"> &lt; ×§×•×“×</button>
<h3 id="monthYearDisplay"></h3>
<button onclick="nextMonth()"> ×”×‘× &gt;</button>
</div>
<div id="weekdays"><div>×'</div><div>×‘'</div><div>×’'</div><div>×“'</div><div>×”'</div><div>×•'</div><div>×©'</div></div>
<div id="calendar"></div>
</div>

<div id="slotsWrapper" class="panel">
<h3>×‘×—×¨ ×ª×•×¨ ×¤× ×•×™: <span id="selectedDateDisplay"></span></h3>
<div id="slots-list">
<p style="text-align:center; color:#ccc;">×‘×—×¨ ×ª××¨×™×š ×‘×œ×•×— ×”×©× ×” ×œ×”×¦×’×ª ×ª×•×¨×™× ×¤× ×•×™×™×.</p>
</div>
</div>

<div id="form-and-check-wrapper">
<div id="formPanel" class="panel">
<h3>×¤×¨×˜×™ ×”×–×× ×”</h3>
<div class="input-group">
<label for="firstName"> </label>
<input type="text" id="firstName" placeholder="×©× ×¤×¨×˜×™" required autocomplete="off">
</div>
<div class="input-group">
<label for="lastName"> </label>
<input type="text" id="lastName" placeholder="×©× ××©×¤×—×”" required autocomplete="off">
</div>
<div class="input-group">
<label for="phone"> </label>
<input type="tel" id="phone" placeholder="×˜×œ×¤×•×Ÿ" required autocomplete="off">
</div>
<div class="input-group">
  <label for="carNumber"> </label>
  <input
    type="text"
    id="carNumber"
    placeholder="××¡×¤×¨ ×¨×›×‘"
    autocomplete="off"
    inputmode="numeric"
    maxlength="8"
    style="direction:ltr;"
  >
</div>



<div class="action-buttons-container" style="display: flex; flex-direction: column; gap: 10px;">

<div style="display: flex; gap: 10px; width: 100%;">
<button id="bookBtn" onclick="bookAppointment(false)" disabled style="flex: 1; padding: 12px; white-space: nowrap;">âœ… ××©×¨ ×”×–×× ×”</button>
<button id="swapBtn" onclick="bookAppointment(true)" disabled style="flex: 1; padding: 12px; white-space: nowrap;">ğŸ”„ ×”×—×œ×£ ×ª×•×¨</button>
</div>

</div>
<p id="bookingMessage" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
</div>

<div id="checkPanel" class="panel">
<h3>×‘×“×™×§×ª ×ª×•×¨ ×§×™×™× / ×‘×™×˜×•×œ</h3>
<div id="checkForm">
<input type="text" id="checkCarInput" placeholder="×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘ ×œ×‘×“×™×§×”" autocomplete="off" style="width:100%; padding:10px; font-size:16px; border:1px solid var(--border-input); border-radius:6px; background:var(--bg-input); color:var(--text-main); margin-bottom:10px;">
<button id="checkBtn" onclick="checkAppointment(true)">ğŸ” ×‘×“×•×§ ×ª×•×¨</button>
</div>
</div>
</div>
</div>

<div id="postBookingScreen">
<h1 id="postTitle" style="color:#4CAF50; font-size: 3em;">×ª×•×“×”!</h1>
<h2 id="postSubtitle" style="color:#ddd; margin-bottom: 30px;">×”×ª×•×¨ ×©×œ×š × ×©××¨ ×‘××¢×¨×›×ª.</h2>

<button id="btnReturn" class="post-btn btn-return" onclick="returnToBooking()">
âœï¸ ×—×–×¨×” ×œ××¢×¨×›×ª
</button>

<button class="post-btn btn-exit" onclick="exitSystem()">
ğŸ‘‹ ×¡×™×•× ×•×™×¦×™××” ××”××¢×¨×›×ª
</button>
</div>

<script>
// ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ×§×œ×˜ (××•× ×¢×ª ×”×–×¨×§×ª ×§×•×“ HTML/JS)
function sanitizeInput(input) {
  if (!input) return "";
  return input.toString()
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;")
  .replace(/"/g, "&quot;")
  .replace(/'/g, "&#039;");
}
// === ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ××ª×’×¨ ×”××ª××˜×™ ===
let correctMathAnswer = 0;
let cancelMathAnswer = 0;

// === ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×ª×¨×’×™×œ ×—×“×© ===
function generateMathChallenge() {
  // 1. ×”×’×¨×œ×” ×•×—×™×©×•×‘
  const n1 = Math.floor(Math.random() * 9) + 1;
  const n2 = Math.floor(Math.random() * 9) + 1;
  correctMathAnswer = n1 + n2;
  
  // 2. ×”×¦×’×” ×¢×œ ×”××¡×š
  const qEl = document.getElementById('mathQ');
  if (qEl) qEl.innerText = `${n1} + ${n2}`;
  
  // 3. ×—×©×™×¤×ª ×”××–×•×¨
  const ansInput = document.getElementById('mathAns');
  const container = document.getElementById('humanCheck');
  
  if (container) container.style.display = 'block';
  
  // 4. ×œ×•×’×™×§×ª ×¤×•×§×•×¡ ×—×›××”
  if (ansInput) {
    ansInput.value = ''; // ××™×¤×•×¡ ×ª×©×•×‘×” ×§×•×“××ª
    
    const phoneEl = document.getElementById('phone');
    
    // ×”×ª× ××™ ×”×—×›×: × ×¢×‘×™×¨ ×¤×•×§×•×¡ ×œ×—×™×“×” *×¨×§ ××* ×”×˜×œ×¤×•×Ÿ ×›×‘×¨ ××œ× (10 ×¡×¤×¨×•×ª)
    // ××—×¨×ª - ×œ× × ×¤×¨×™×¢ ×œ××©×ª××©, ×”×•× ×™×’×™×¢ ×œ×©× ×œ×‘×“ ××—×¨×™ ×”×˜×œ×¤×•×Ÿ
    if (phoneEl && phoneEl.value.length === 10) {
      setTimeout(() => {
        ansInput.focus();
      }, 100);
    }
  }
}
function generateCancelMathChallenge() {
  const n1 = Math.floor(Math.random() * 9) + 1;
  const n2 = Math.floor(Math.random() * 9) + 1;
  cancelMathAnswer = n1 + n2;
  
  const qEl = document.getElementById('cancelMathQ');
  const ansEl = document.getElementById('cancelMathAns');
  
  if (qEl) qEl.innerText = `${n1} + ${n2}`;
  if (ansEl) ansEl.value = '';
  // â¬…ï¸ ×¤×•×§×•×¡ ××•×˜×•××˜×™ ×œ×©×“×” ×”×ª×©×•×‘×”
  setTimeout(() => {
    ansEl.focus();
  }, 50);
}

// --- ×¤×•× ×§×¦×™×™×ª ×”×—×œ×¤×ª ×¢×¨×›×ª × ×•×©× (×—×“×©) ---
function toggleTheme() {
  document.body.classList.toggle('light-mode');
  const isLight = document.body.classList.contains('light-mode');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');
}
// ×”×¤×¢×œ×” ×‘×˜×¢×™× ×ª ×”×“×£
(function() {
  if (localStorage.getItem('theme') === 'light') {
    document.body.classList.add('light-mode');
  }
})();

// ------------------- ×”×—×œ×¤×”------------------

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyA3UGkULozPWRmUGzFPFml67vK0QssEL5U",
  authDomain: "my-car-app-f2235.firebaseapp.com",
  databaseURL: "https://my-car-app-f2235-default-rtdb.firebaseio.com",
  projectId: "my-car-app-f2235",
  storageBucket: "my-car-app-f2235.firebasestorage.app",
  messagingSenderId: "937970174514",
  appId: "1:937970174514:web:c4c2fe7c706220b07e0a2b"
};
// ------------------- ×”×—×œ×¤×”------------------

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch (error) {
  console.error("Firebase Init Error:", error);
  document.getElementById('loadingOverlay').style.display = 'flex';
  document.getElementById('connectionStatus').innerText = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¢×¨×›×ª. ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.";
  document.getElementById('retryBtn').style.display = 'block';
}

let globalData = {};
let selectedDate = null;
let selectedTime = null;
let systemCalendarTitle = "×ª×•×¨ ×—×“×©";

function normalizePhone(phone) {
  if (!phone) return '';
  return phone.replace(/[\s-]/g, '');
}

function dateToKey(dateObj){
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth()+1).padStart(2,"0");
  const d = String(dateObj.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

function timeToMinutes(t){
  if (!t || typeof t !== 'string') return -1;
  const parts = t.split(":").map(Number);
  if (parts.length !== 2) return -1;
  const [h,m] = parts;
  if(isNaN(h) || isNaN(m)) return -1;
  return h*60+m;
}
function minutesToTime(x){ return String(Math.floor(x/60)).padStart(2,"0")+":"+String(x%60).padStart(2,"0"); }

/* =====================================================
×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×ª×•×¨×™× (××¡×•× ×›×¨× ×ª ×¢× ×”×× ×”×œ)
===================================================== */
function generateSlotsWithBreaks(start, end, interval, breaks = []) {
  const out = [];
  let t = timeToMinutes(start);
  let endMin = timeToMinutes(end);
  const step = Number(interval);
  
  // ×˜×™×¤×•×œ ×‘-00:00 ×›×¡×•×£ ×™×•× (24:00)
  if (endMin === 0 && t > 0) {
    endMin = 1440;
  }
  
  if (t === -1 || endMin === -1 || !step || step <= 0 || t > endMin) return [];
  
  // ××™×¤×•×™ ×”×¤×¡×§×•×ª
  const brs = (breaks || [])
  .map(b => ({ start: timeToMinutes(b.start), end: timeToMinutes(b.end) }))
  .filter(b => b.start !== -1 && b.end !== -1 && b.end > b.start)
  .sort((a,b) => a.start - b.start);
  
  // ×œ×•×œ××” ×¨×¦×” ×›×œ ×¢×•×“ ×”×–××Ÿ ×§×˜×Ÿ ××©×¢×ª ×”×¡×™×•× (t < endMin)
  // ×–×” ××‘×˜×™×— ×©×œ× ×™×™×¤×ª×— ×ª×•×¨ ×—×“×© ×‘×“×™×•×§ ×¢×œ ×©×¢×ª ×”×¡×™×•×
  while (t < endMin) {
    
    // ×“×™×œ×•×’ ×¢×œ ×”×¤×¡×§×•×ª
    const inBr = brs.find(b => t >= b.start && t < b.end);
    if (inBr) {
      t = inBr.end;
      continue;
    }
    
    // ×× ×”×ª×•×¨ × ×›× ×¡ ×‘×˜×•×•×— ×”×–××Ÿ - ×”×•×¡×£ ××•×ª×•
    if (t + step <= endMin) {
      out.push(minutesToTime(t));
    }
    
    t += step;
  }
  
  return out;
}

function createGoogleCalLink(date, time, interval, customTitle) {
  const startTime = new Date(`${date}T${time}`);
  const endTime = new Date(startTime.getTime() + interval * 60000);
  const format = (d) => d.toISOString().replace(/-|:|\.\d\d\d/g, "");
  const title = encodeURIComponent(customTitle);
  const details = encodeURIComponent("× ×§×‘×¢ ×ª×•×¨ ×‘××¢×¨×›×ª ×”× ×™×”×•×œ.");
  return `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${format(startTime)}/${format(endTime)}&details=${details}&sf=true&output=xml`;
}

function downloadICS(date, time, interval, customTitle) {
  const startTime = new Date(`${date}T${time}`);
  const endTime = new Date(startTime.getTime() + interval * 60000);
  const format = (d) => d.toISOString().replace(/-|:|\.\d\d\d/g, "");
  const icsContent = [
  "BEGIN:VCALENDAR", "VERSION:2.0", "BEGIN:VEVENT",
  `DTSTART:${format(startTime)}`, `DTEND:${format(endTime)}`,
  `SUMMARY:${customTitle}`, "DESCRIPTION:× ×§×‘×¢ ×ª×•×¨ ×‘××¢×¨×›×ª.",
  "END:VEVENT", "END:VCALENDAR"
  ].join("\n");
  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const link = document.createElement('a');
  link.href = window.URL.createObjectURL(blob);
  link.setAttribute('download', `appointment_${date}.ics`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function showSuccessModal(date, time, interval, name) {
  const modal = document.getElementById('successModal');
  const btnGoogle = document.getElementById('btnGoogle');
  const btnIcs = document.getElementById('btnIcs');
  const text = document.getElementById('successText');
  const finalTitle = systemCalendarTitle || `×ª×•×¨ ×œ-${name}`;
  text.innerHTML = `${name},<br>× ×§×‘×¢ ×œ×š ×ª×•×¨ ×œ×ª××¨×™×š <b>${date}</b> ×‘×©×¢×” <b>${time}</b>.`;
  btnGoogle.onclick = function() { window.open(createGoogleCalLink(date, time, interval, finalTitle), '_blank'); setTimeout(closeSuccessModal, 500); };
  btnIcs.onclick = function() { downloadICS(date, time, interval, finalTitle); setTimeout(closeSuccessModal, 500); };
  modal.style.display = 'flex';
  window.onclick = function(event) { if (event.target == modal) closeSuccessModal(); }
}

function closeSuccessModal() {
  document.getElementById('successModal').style.display = 'none';
  
  document.getElementById('header-area').style.display = 'none';
  document.getElementById('main-container').style.display = 'none';
  
  const title = document.getElementById('postTitle');
  const sub = document.getElementById('postSubtitle');
  const btn = document.getElementById('btnReturn');
  
  title.innerText = "×ª×•×“×”!";
  title.style.color = "#4CAF50";
  
  sub.innerText = "×”×ª×•×¨ ×©×œ×š × ×©××¨ ×‘××¢×¨×›×ª.";
  
  btn.innerHTML = `âœï¸ ×—×–×¨×” ×œ××¢×¨×›×ª<br><span style="font-size:0.7em; font-weight:normal;">(×œ×©×™× ×•×™ ××•×¢×“ ×ª×•×¨ / ×‘×™×˜×•×œ)</span>`;
  
  document.getElementById('postBookingScreen').style.display = 'flex';
  
  selectedTime = null;
  updateBookingState();
  document.getElementById("checkPhone").value = '';
}

function returnToBooking() {
  document.getElementById('postBookingScreen').style.display = 'none';
  document.getElementById('header-area').style.display = 'block';
  document.getElementById('main-container').style.display = 'flex';
  if(selectedDate) { renderAvailableSlots(); }
}

function exitSystem() {
  document.getElementById("firstName").value = '';
  document.getElementById("lastName").value = '';
  document.getElementById("phone").value = '';
  document.body.innerHTML = `
  <div style="display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; text-align:center;">
  <h1 style="color:#4facfe;">×œ×”×ª×¨××•×ª!</h1>
  <p style="color:#ccc;">×”××©×š ×™×•× × ×¢×™×.</p>
  <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#444; color:white; border:none; border-radius:5px; cursor:pointer;">
  ×”×ª×—×œ ××—×“×©
  </button>
  </div>
  `;
}

let currentMonthDate = new Date();
function prevMonth() { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); buildCalendar(); }
function nextMonth() { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); buildCalendar(); }

function buildCalendar(){
  const cal = document.getElementById("calendar"); cal.innerHTML="";
  const monthNames = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];
  const year = currentMonthDate.getFullYear();
  const month = currentMonthDate.getMonth();
  document.getElementById("monthYearDisplay").innerText = `${monthNames[month]} ${year}`;
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const now = new Date();
  const todayKey = dateToKey(new Date(now.getFullYear(), now.getMonth(), now.getDate()));
  
  for(let i=0; i<firstDay; i++) cal.appendChild(document.createElement("div"));
  
  for(let d=1; d<=daysInMonth; d++){
    const dateObj = new Date(year,month,d);
    const key = dateToKey(dateObj);
    const div = document.createElement("div");
    div.className="day";
    div.innerText=d;
    div.setAttribute("data-date", key);
    
    if (key < todayKey) {
      div.classList.add("disabled", "past");
    } else {
      const dayData = globalData[key];
      if (!dayData || !dayData.settings) {
        div.classList.add("disabled");
      } else {
        let availableSlots = getAvailableSlots(dayData);
        if (key === todayKey) {
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          availableSlots = availableSlots.filter(time => timeToMinutes(time) > currentMinutes);
        }
        if(availableSlots.length > 0) {
          div.classList.add("has-slots");
          div.onclick = () => selectDate(key);
        } else {
          div.classList.add("disabled");
        }
      }
    }
    if(key === selectedDate) div.classList.add("selected-day");
    cal.appendChild(div);
  }
}

function selectDate(dateKey) {
  selectedDate = dateKey;
  selectedTime = null;
  
  // 1. ×”×¡×¨×ª ×”×¡×™××•×Ÿ ××›×œ ×”×™××™× ×‘×œ×•×—
  document.querySelectorAll('.day').forEach(d => d.classList.remove('selected-day'));
  
  // 2. ×”×•×¡×¤×ª ×”×¡×™××•×Ÿ (×”×¢×™×’×•×œ ×”×›×—×•×œ) ×œ×™×•× ×©× ×œ×—×¥
  const currentDayEl = document.querySelector(`[data-date="${dateKey}"]`);
  if (currentDayEl) {
    currentDayEl.classList.add('selected-day');
  }
  
  renderAvailableSlots();
  updateBookingState();
}

function getAvailableSlots(dayData){
  if(!dayData || !dayData.settings) return [];
  const s = dayData.settings || {};
  const baseSlots = generateSlotsWithBreaks(s.range1Start, s.range1End, s.range1Interval, s.breaks || []);
  const appointments = dayData.appointments || [];
  const globalCap = parseInt(s.maxSlots) || 1;
  const extraTimes = appointments.filter(a => a.status === 'EXTRA_CAPACITY').map(a => a.time);
  const allTimes = [...new Set([...baseSlots, ...extraTimes])];
  const available = allTimes.filter(time => {
    const extras = appointments.filter(a => a.time === time && a.status === 'EXTRA_CAPACITY').length;
    const limit = (baseSlots.includes(time) ? globalCap : 0) + extras;
    const used = appointments.filter(a => a.time === time && (a.phone || a.status === 'DELETED')).length;
    return used < limit;
  });
  const manualOutOfRange = appointments.filter(a => a.status === "MANUAL" && !baseSlots.includes(a.time)).map(a => a.time);
  const validManualOutOfRange = manualOutOfRange.filter(time => {
    const bookings = appointments.filter(a => a.time === time && a.phone && a.status !== "DELETED").length;
    const manuals = appointments.filter(a => a.time === time && a.status === "MANUAL").length;
    return bookings < manuals;
  });
  return [...new Set(available.concat(validManualOutOfRange))].sort();
}

function renderAvailableSlots(){
  const slotsDiv = document.getElementById("slots-list");
  if (!selectedDate) {
    slotsDiv.innerHTML = '<p style="text-align:center; color:#ccc;">×‘×—×¨ ×ª××¨×™×š ×‘×œ×•×— ×”×©× ×” ×œ×”×¦×’×ª ×ª×•×¨×™× ×¤× ×•×™×™×.</p>';
    return;
  }
  const dayData = globalData[selectedDate] || {};
  let availableSlots = getAvailableSlots(dayData);
  const now = new Date();
  if (selectedDate === dateToKey(now)) {
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    availableSlots = availableSlots.filter(time => timeToMinutes(time) > currentMinutes);
  }
  if (availableSlots.length === 0) {
    slotsDiv.innerHTML = '<p style="text-align:center; color:orange; font-weight:bold;">××™×Ÿ ×ª×•×¨×™× ×¤× ×•×™×™× (××• ×©×–×× × ×¢×‘×¨).</p>';
    return;
  }
  let html = '';
  availableSlots.forEach(time => {
    const isSelected = selectedTime === time ? ' selected' : '';
    html += `<button class="slot-btn${isSelected}" data-time="${time}" onclick="selectTime('${time}', this)">${time}</button>`;
  });
  slotsDiv.innerHTML = html;
}

function selectTime(time, element){
  selectedTime = time;
  document.querySelectorAll('.slot-btn').forEach(btn => btn.classList.remove('selected'));
  element.classList.add('selected');
  updateBookingState();
  generateMathChallenge();
}

function updateBookingState(){
  const bookBtn = document.getElementById("bookBtn");
  const swapBtn = document.getElementById("swapBtn"); // ×”×•×¡×¤× ×• ××ª ×”×›×¤×ª×•×¨ ×”×—×“×©
  const msg = document.getElementById("bookingMessage");
  
  if(selectedDate && selectedTime){
    bookBtn.disabled = false;
    swapBtn.disabled = false; //××¤×¢×™×œ ××ª ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×ª×•×¨
    msg.innerText = `×ª×•×¨ × ×‘×—×¨: ${selectedDate}, ×©×¢×” ${selectedTime}`;
    msg.style.color = '#4CAF50';
  } else {
    bookBtn.disabled = true;
    swapBtn.disabled = true; //××›×‘×” ××ª ×›×¤×ª×•×¨ ×”×—×œ×¤×ª ×ª×•×¨
    msg.innerText = "×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×ª×•×¨ ×¤× ×•×™.";
    msg.style.color = 'orange';
  }
}

// --- ×œ×•×’×™×§×” ×—×“×©×”: ×‘×“×™×§×ª ×ª×•×¨ ×¢× ×—×œ×•×Ÿ ×§×•×¤×¥ ---

function cancelExistingAppointmentLogic(data, dateKey, time, phone) {
  if (!data[dateKey] || !data[dateKey].appointments) return data;
  const appts = data[dateKey].appointments;
  const normPhone = normalizePhone(phone);
  const index = appts.findIndex(a => a.time === time && normalizePhone(a.phone) === normPhone);
  if (index > -1) appts.splice(index, 1);
  return data;
}

// =========================================================================
// === ×§×•×“ ×—×“×©: ×˜×™×¤×•×œ ×‘×¨×™×‘×•×™ ×ª×•×¨×™× (×‘×“×™×§×”, ×‘×™×˜×•×œ, ×”×—×œ×¤×”) ===
// =========================================================================

// --- 1. ××¦×™××ª ×›×œ ×”×ª×•×¨×™× ×”×¢×ª×™×“×™×™× ×©×œ ×¨×›×‘ ××¡×•×™× ---
function getAllFutureAppointments(carNumberVal) { // ×”×©× × ×©××¨, ×”×¤×¨××˜×¨ ×›×¢×ª ××™×™×¦×’ ×¨×›×‘
  const results = [];
  const now = new Date();
  
  // × ×™×§×•×™ ×¨×•×•×—×™× ×××¡×¤×¨ ×”×¨×›×‘
  const targetCar = String(carNumberVal).trim();

  Object.keys(globalData).forEach(dateKey => {
    const day = globalData[dateKey];
    if (day && day.appointments) {
      day.appointments.forEach(app => {
        // ×”××¨×ª ×–××Ÿ ×”×ª×•×¨ ×œ××•×‘×™×™×§×˜ Date
        const appDate = new Date(dateKey + 'T' + app.time);
        
        // ×‘×“×™×§×”: ×”×× ×”×ª×•×¨ ×¢×ª×™×“×™ + ×œ× × ××—×§ + ××¡×¤×¨ ×”×¨×›×‘ ×ª×•××
        if (appDate > now && app.status !== "DELETED") {
            // ×›××Ÿ ×”×©×™× ×•×™: ×”×©×•×•××” ××•×œ app.carNumber ×‘××§×•× app.phone
            if (app.carNumber && String(app.carNumber).trim() === targetCar) {
                // ×”×•×¡×¤×ª ×”×ª××¨×™×š ×œ××•×‘×™×™×§×˜ ×”×ª×•×¨ ×›×“×™ ×©× ×“×¢ ××ª×™ ×”×•×
                results.push({ ...app, date: dateKey });
            }
        }
      });
    }
  });
  
  // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×•×©×¢×”
  results.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
  return results;
}

// --- 2. ×‘×“×™×§×ª ×ª×•×¨×™× (Check) - ××¦×™×’ ×¨×©×™××” ×× ×™×© ×¨×™×‘×•×™ ×ª×•×¨×™× ---
function checkAppointment(showOverlay = true) {
  // ×§×¨×™××” ××©×“×” ×”×¨×›×‘ ×”×—×“×©
  const rawInput = document.getElementById("checkCarInput").value.trim();
  
  if (!rawInput) {
     if(showOverlay) alert("× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¨×›×‘ ×œ×‘×“×™×§×”.");
     return;
  }

  // ×—×™×¤×•×© ×œ×¤×™ ×¨×›×‘
  const allAppts = getAllFutureAppointments(rawInput);
  
  const modal = document.getElementById('checkResultModal');
  const title = document.getElementById('checkModalTitle');
  const text = document.getElementById('checkModalText');
  const actions = document.getElementById('checkModalActions');
  const icon = document.getElementById('checkModalIcon');

  if (allAppts.length > 0) {
    icon.innerText = "ğŸ“…";
    title.innerText = `× ××¦××• ${allAppts.length} ×ª×•×¨×™×`;
    title.style.color = "#4CAF50";
    
    let html = `<div style="text-align:right;">`;
    allAppts.forEach(app => {
        html += `
        <div style="background:var(--bg-input); padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid var(--border-input); display:flex; justify-content:space-between; align-items:center;">
           <div>
             <strong>${app.date}</strong> | ${app.time}<br>
             <span style="font-size:0.9em; color:#aaa;">×¨×›×‘: ${app.carNumber}</span>
           </div>
           <button onclick="showCancelConfirmModal('${app.date}', '${app.time}', '${rawInput}')" 
             style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">
             ×‘×™×˜×•×œ
           </button>
        </div>`;
    });
    html += `</div>`;
    
    text.innerHTML = html;
    actions.innerHTML = `<button class="btn-exit" onclick="document.getElementById('checkResultModal').style.display='none'">×¡×’×•×¨</button>`;
  } else {
    icon.innerText = "âŒ";
    title.innerText = "×œ× × ××¦×";
    title.style.color = "#dc3545";
    text.innerText = "×œ× × ××¦××• ×ª×•×¨×™× ×¢×ª×™×“×™×™× ×œ×¨×›×‘ ×–×”.";
    actions.innerHTML = `<button class="btn-exit" onclick="document.getElementById('checkResultModal').style.display='none'">×¡×’×•×¨</button>`;
  }
  
  modal.style.display = 'flex';
}

function showCancelConfirmModal(dateKey, time, phone) {
  const modal = document.getElementById('checkResultModal');
  const icon = document.getElementById('checkModalIcon');
  const title = document.getElementById('checkModalTitle');
  const text = document.getElementById('checkModalText');
  const actions = document.getElementById('checkModalActions');
  
  icon.innerText = "âš ï¸";
  title.innerText = "××™×©×•×¨ ×‘×™×˜×•×œ ×ª×•×¨";
  title.style.color = "#dc3545";
  
  text.innerHTML = `
  <div style="
  background:var(--bg-input);
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border-input);
  text-align:right;
  margin-bottom:12px;
  ">
  <div><b>×ª××¨×™×š:</b> ${dateKey}</div>
  <div><b>×©×¢×”:</b> ${time}</div>
  </div>
  
  <div style="
  background:rgba(255,255,255,0.05);
  border:1px solid var(--border-input);
  border-radius:8px;
  padding:10px;
  text-align:center;
  ">
  <div style="margin-bottom:6px; font-size:0.9em; color:var(--text-muted);">
  ×‘×“×™×§×ª ××‘×˜×—×”
  </div>
  
  <div style="display:flex; justify-content:center; align-items:center; gap:8px; direction:ltr;">
  <span id="cancelMathQ" style="font-size:1.2em; font-weight:bold;">?</span>
  <span>=</span>
  <input id="cancelMathAns" type="number"
  style="
  width:60px;
  text-align:center;
  padding:6px;
  border-radius:6px;
  border:1px solid var(--border-input);
  background:var(--bg-input);
  color:var(--text-main);
  font-size:1.1em;
  ">
  </div>
  </div>
  `;
  
  actions.innerHTML = `
  <button class="btn-cancel-appt"
  onclick="confirmCancelAppointment('${dateKey}','${time}','${phone}')">
  âŒ ×‘×˜×œ ×ª×•×¨
  </button>
  <button class="btn-exit"
  onclick="document.getElementById('checkResultModal').style.display='none'">
  ×—×–×¨×”
  </button>
  `;
  generateCancelMathChallenge();
  
  modal.style.display = 'flex';
}

function confirmCancelAppointment(dateKey, time, phone) {
  const userAns = parseInt(document.getElementById('cancelMathAns').value);
  
  if (isNaN(userAns) || userAns !== cancelMathAnswer) {
    alert("×ª×©×•×‘×ª ×”××‘×˜×—×” ×©×’×•×™×”. × ×¡×” ×©×•×‘.");
    generateCancelMathChallenge();
    return;
  }
  
  document.getElementById('checkResultModal').style.display = 'none';
  cancelAppointmentFinal(dateKey, time, phone);
}

// --- 3. ×‘×™×˜×•×œ ×ª×•×¨ ×¡×¤×¦×™×¤×™ ---
async function cancelAppointmentFinal(dateKey, time, identifier) {
  // identifier ××›×™×œ ×›×¢×ª ××ª ××¡×¤×¨ ×”×¨×›×‘
  const data = JSON.parse(JSON.stringify(globalData));
  const day = data[dateKey];
  
  if (!day || !day.appointments) {
      alert("×©×’×™××” ×‘××™×ª×•×¨ ×”×ª×•×¨.");
      return;
  }
  
  // ×—×™×¤×•×© ×”××™× ×“×§×¡ ×œ××—×™×§×” ×œ×¤×™ ×¨×›×‘ ×•×©×¢×”
  const index = day.appointments.findIndex(a => 
      String(a.carNumber).trim() === String(identifier).trim() && 
      a.time === time && 
      a.status !== "DELETED"
  );
  
  if (index > -1) {
    day.appointments.splice(index, 1);
    await saveData(data); // ×©××™×¨×”
    
    // ×”×•×“×¢×ª ×”×¦×œ×—×” ×•× ×™×§×•×™
    showPostActionScreen("×‘×•×˜×œ", "#dc3545", "×”×ª×•×¨ ×‘×•×˜×œ ×‘×”×¦×œ×—×”.");
    document.getElementById("checkCarInput").value = ''; // × ×™×§×•×™ ×©×“×” ×”×¨×›×‘
    document.getElementById('checkResultModal').style.display = 'none';
  } else {
    alert("×©×’×™××”: ×œ× × ××¦× ×”×ª×•×¨ ×œ××—×™×§×” (××™ ×”×ª×××” ×‘× ×ª×•× ×™ ×¨×›×‘).");
  }
}

// --- 4. ×”×–×× ×ª ×ª×•×¨ / ×”×—×œ×¤×” (×œ×•×’×™×§×” ×¨××©×™×ª) ---
// ==========================================
// === 1. ×œ×•×’×™×§×” ×œ×—×œ×•×Ÿ ×”×ª×¨×’×™×œ ×”×—×“×© ===
// ==========================================
let pendingActionCallback = null;
let verifyCorrectAnswer = 0;

function openMathVerifyModal(actionCallback) {
  pendingActionCallback = actionCallback;
  
  // ×™×¦×™×¨×ª ×ª×¨×’×™×œ ×—×“×©
  const n1 = Math.floor(Math.random() * 9) + 1;
  const n2 = Math.floor(Math.random() * 9) + 1;
  verifyCorrectAnswer = n1 + n2;
  
  // ×¢×“×›×•×Ÿ ×”××¡×¤×¨×™× ×‘×—×œ×•×Ÿ
  document.getElementById('verifyMathQ').innerText = `${n1} + ${n2}`;
  const input = document.getElementById('verifyMathAns');
  input.value = '';
  
  // ×”×¦×’×ª ×”×—×œ×•×Ÿ (Flex ×œ××¨×›×•×–)
  document.getElementById('mathVerifyModal').style.display = 'flex';
  
  // ×¤×•×§×•×¡ ××•×˜×•××˜×™ ×œ×©×“×” ×”×ª×©×•×‘×”
  setTimeout(() => { input.focus(); }, 150);
}

function submitMathVerify() {
  const userAns = parseInt(document.getElementById('verifyMathAns').value);
  
  if (userAns === verifyCorrectAnswer) {
    // ×ª×©×•×‘×” × ×›×•× ×” - ×¡×’×•×¨ ×—×œ×•×Ÿ ×•×‘×¦×¢ ××ª ×”×¤×¢×•×œ×”
    document.getElementById('mathVerifyModal').style.display = 'none';
    if (pendingActionCallback) {
      pendingActionCallback();
      pendingActionCallback = null;
    }
  } else {
    alert("×ª×©×•×‘×” ×©×’×•×™×”, × ×¡×” ×©×•×‘.");
    document.getElementById('verifyMathAns').value = '';
    document.getElementById('verifyMathAns').focus();
  }
}

// ×××¤×©×¨ ×œ×—×™×¦×ª Enter ×‘×ª×•×š ×—×œ×•×Ÿ ×”×ª×¨×’×™×œ
const verifyInputEl = document.getElementById('verifyMathAns');
if(verifyInputEl){
  verifyInputEl.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') submitMathVerify();
  });
}

// ==========================================
// === ×¤×•× ×§×¦×™×™×ª ×”×–×× ×” ×¨××©×™×ª (bookAppointment) - ××ª×•×§× ×ª ===
// ==========================================
async function bookAppointment(isSwap = false) {
  // --- ×. ××™×¡×•×£ × ×ª×•× ×™× ---
  const rawFirst = document.getElementById("firstName").value.trim();
  const rawLast = document.getElementById("lastName").value.trim();
  const rawPhone = document.getElementById("phone").value.trim();
  const rawCar = document.getElementById("carNumber").value.trim(); // <== ×”×©×™× ×•×™: ×§×¨×™××” ×œ××¡×¤×¨ ×¨×›×‘

  // × ×™×§×•×™ × ×ª×•× ×™× (×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×§×™×™××ª ×× ×™×©× ×”)
  const first = (typeof sanitizeInput === 'function') ? sanitizeInput(rawFirst) : rawFirst;
  const last = (typeof sanitizeInput === 'function') ? sanitizeInput(rawLast) : rawLast;
  const phone = rawPhone.replace(/\D/g,''); 
  const carNum = rawCar.replace(/\W/g, ''); // ×× ×§×” ×ª×•×•×™× ××™×•×—×“×™× ×××¡×¤×¨ ×”×¨×›×‘

  // --- ×‘. ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª ×‘×¡×™×¡×™×•×ª ---
  if (!selectedDate || !selectedTime) {
    alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×©×¢×”.");
    return;
  }
  
  // ×‘×“×™×§×” ×©×›×œ ×”×©×“×•×ª ××œ××™× - ×›×•×œ×œ ×¨×›×‘
  if (!first || !last || !phone || !carNum) {
    alert("× × ×œ××œ× ××ª ×›×œ ×”×¤×¨×˜×™× (×›×•×œ×œ ××¡×¤×¨ ×¨×›×‘).");
    return;
  }

  // ×•×œ×™×“×¦×™×” ×œ×˜×œ×¤×•×Ÿ ×•×œ×¨×›×‘
  if (phone.length < 9) { // ×’××™×©×•×ª ×§×œ×” ×‘×˜×œ×¤×•×Ÿ
    alert("××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××™× ×• ×ª×§×™×Ÿ.");
    return;
  }
  if (carNum.length < 5) { // ×‘×“×™×§×ª ××•×¨×š ××™× ×™××œ×™ ×œ×¨×›×‘
      alert("××¡×¤×¨ ×¨×›×‘ ×§×¦×¨ ××“×™.");
      return;
  }
  
  // --- ×’. ×‘×“×™×§×ª ×ª×•×¨×™× ×§×™×™××™× ×‘××¢×¨×›×ª ---
  // <== ×”×©×™× ×•×™ ×”×’×“×•×œ: ×©×•×œ×¤×™× ×œ×¤×™ ××¡×¤×¨ ×¨×›×‘ ×‘××§×•× ×œ×¤×™ ×˜×œ×¤×•×Ÿ ==>
  const allAppts = getAllFutureAppointments(carNum);
  
  // --- ×“. × ×™×ª×•×‘ ×œ×¤×™ ×¡×•×’ ×¤×¢×•×œ×” ---
  
  // ××§×¨×” 1: ×”×–×× ×” ×¨×’×™×œ×”
  if (!isSwap) {
    // ×× ×›×‘×¨ ×™×© ×ª×•×¨ ×œ×¨×›×‘ ×”×–×”
    if (allAppts.length > 0) {
      const exist = allAppts[0];
      alert(`×§×™×™× ×›×‘×¨ ×ª×•×¨ ×œ×¨×›×‘ ${carNum} ×‘×ª××¨×™×š ${exist.date} ×‘×©×¢×” ${exist.time}.\n\n×œ× × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×ª×•×¨ ×›×¤×•×œ.\n×œ×”×—×œ×¤×”, ×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×”×›×ª×•×: "×”×—×œ×£ ×ª×•×¨ ×§×™×™×".`);
      
      // ××•×¤×¦×™×•× ×œ×™: ×—×©×™×¤×ª ×›×¤×ª×•×¨ ×”×”×—×œ×¤×” ×›××Ÿ
      document.getElementById('swapBtn').disabled = false;
      document.getElementById('bookBtn').disabled = true;
      return; 
    }
    
    // ×× ××™×Ÿ ×ª×•×¨×™× -> ×¤×ª×— ×‘×“×™×§×ª ××‘×˜×—×” -> ×•××– ×‘×¦×¢ ×”×–×× ×”
    // ×©×™× ×œ×‘: ×”×•×¡×¤× ×• ××ª carNum ×œ×§×¨×™××” ×œ-performBooking
    openMathVerifyModal(() => {
      performBooking(first, last, phone, carNum, selectedDate, selectedTime);
    });
    return;
  }
  
  // ××§×¨×” 2: ×”×—×œ×¤×ª ×ª×•×¨ (isSwap === true)
  
  if (allAppts.length === 0) {
    alert(`×œ× × ××¦××• ×ª×•×¨×™× ×§×™×™××™× ×œ×”×—×œ×¤×” ×¢×‘×•×¨ ×¨×›×‘ ${carNum}.`);
    return;
  }
  
  // ×× ×™×© ×ª×•×¨ ××—×“ - ×”×—×œ×¤×” ×™×©×™×¨×”
  if (allAppts.length === 1) {
    const oldAppt = allAppts[0];
    openMathVerifyModal(() => {
      // ×’× ×›××Ÿ, ××¢×‘×™×¨×™× ××ª carNum ×•×’× ××ª oldAppt ×œ××—×™×§×”
      performBooking(first, last, phone, carNum, selectedDate, selectedTime, oldAppt);
    });
  }
  // ×× ×™×© ×¨×™×‘×•×™ ×ª×•×¨×™× (× ×“×™×¨ ×‘×¨×›×‘, ××‘×œ ××¤×©×¨×™) - ×¤×ª×™×—×ª ×¨×©×™××ª ×‘×—×™×¨×”
  else {
    // ×¦×¨×™×š ×œ×•×•×“× ×©×¤×•× ×§×¦×™×™×ª ×”×‘×—×™×¨×” ×ª×•××›×ª ×‘×”×¦×’×ª ××¡×¤×¨×™ ×¨×›×‘, ××‘×œ ×œ×¨×•×‘ ×–×” ×™×¢×‘×•×“ ×’× ×›×š
    showSwapSelectionModal(allAppts, first, last, phone, carNum);
  }
}

// ==========================================
// === ×¤×•× ×§×¦×™×•×ª ×˜×™×¤×•×œ ×‘×¨×™×‘×•×™ ×ª×•×¨×™× (×”×—×œ×¤×”) ===
// ==========================================

function showSwapSelectionModal(appts, first, last, phone) {
  const modal = document.getElementById('checkResultModal');
  const title = document.getElementById('checkModalTitle');
  const text = document.getElementById('checkModalText');
  const actions = document.getElementById('checkModalActions');
  const icon = document.getElementById('checkModalIcon');
  
  // ×¢×™×¦×•×‘
  if(icon) icon.innerText = "ğŸ”„";
  if(title) {
    title.innerText = "×‘×—×¨ ×ª×•×¨ ×œ×”×—×œ×¤×”";
    title.style.color = "#ff9800";
  }
  
  // ×‘× ×™×™×ª ×”×¨×©×™××”
  let html = `<p style="margin-bottom:10px;">×‘×—×¨ ××ª ×”×ª×•×¨ ×©×‘×¨×¦×•× ×š <b>×œ×‘×˜×œ</b>:</p>`;
  html += `<div style="text-align:right; max-height:200px; overflow-y:auto; border:1px solid #444; padding:10px; border-radius:8px;">`;
  
  appts.forEach(appt => {
    const apptDataStr = encodeURIComponent(JSON.stringify(appt));
    
    html += `
    <div style="background:var(--bg-input, #333); padding:10px; margin-bottom:8px; border-radius:6px; border:1px solid #555; display:flex; justify-content:space-between; align-items:center;">
    <div>
    <div style="font-weight:bold;">${appt.date}</div>
    <div style="color:#aaa;">${appt.time}</div>
    </div>
    
    <button onclick="prepareSwapFromList('${apptDataStr}', '${first}', '${last}', '${phone}')"
    style="background:#ff9800; color:white; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; font-weight:bold;">
    ×”×—×œ×£
    </button>
    </div>
    `;
  });
  html += `</div>`;
  
  if(text) text.innerHTML = html;
  if(actions) actions.innerHTML = `<button class="btn-exit" onclick="document.getElementById('checkResultModal').style.display='none'">×‘×™×˜×•×œ</button>`;
  
  if(modal) modal.style.display = 'flex';
}

// ×¤×•× ×§×¦×™×™×ª ×‘×™× ×™×™×: ×¡×•×’×¨×ª ×¨×©×™××” -> ×¤×•×ª×—×ª ×ª×¨×’×™×œ -> ××‘×¦×¢×ª ×”×—×œ×¤×”
function prepareSwapFromList(apptDataStr, first, last, phone) {
  // 1. ×¡×’×•×¨ ××ª ×¨×©×™××ª ×”×ª×•×¨×™×
  document.getElementById('checkResultModal').style.display = 'none';
  
  // 2. ×¤×¢× ×— ××ª ×”×ª×•×¨ ×©× ×‘×—×¨
  const oldAppt = JSON.parse(decodeURIComponent(apptDataStr));
  
  // 3. ×¤×ª×— ××ª ×”×ª×¨×’×™×œ
  openMathVerifyModal(() => {
    // 4. ×¨×§ ××—×¨×™ ×”×¦×œ×—×” ×‘×ª×¨×’×™×œ - ×‘×¦×¢ ××ª ×”×”×—×œ×¤×”
    performBooking(first, last, phone, selectedDate, selectedTime, oldAppt);
  });
}

// --- 6. ×¤×•× ×§×¦×™×™×ª ×‘×™×¦×•×¢ ×”×”×—×œ×¤×” ××”×¨×©×™××” ---
async function confirmSwapFromList(apptDataStr, first, last, phone) {
  const oldAppt = JSON.parse(decodeURIComponent(apptDataStr));
  document.getElementById('checkResultModal').style.display = 'none';
  await performBooking(first, last, phone, selectedDate, selectedTime, oldAppt);
}

// --- 7. ×¤×•× ×§×¦×™×™×ª ×‘×™×¦×•×¢ ×”×”×–×× ×” ×‘×¤×•×¢×œ (×©××™×¨×” ×‘-DB) ---
async function performBooking(first, last, phone, carNum, date, time, oldAppt = null) {
  
  const data = globalData; 
  
  // ×”×•×“×¢×” ×œ××©×ª××© (××•×¤×¦×™×•× ×œ×™ - ×›×“×™ ×©×™×‘×™×Ÿ ×©×™×© ×”××ª× ×” ×§×¦×¨×”)
  // ×× ×™×© ×œ×š ××œ×× ×˜ ×œ×˜×¢×™× ×” ××¤×©×¨ ×œ×”×¤×¢×™×œ ××•×ª×• ×›××Ÿ

  // --- 1. ××©×™×›×ª ×¤×¨×˜×™ ×¨×›×‘ (×”×ª×•×¡×¤×ª ×”×—×“×©×”) ---
  let extraInfo = { model: '', year: '' };
  if (carNum && carNum.length >= 5) {
      // ×××ª×™×Ÿ ×œ×ª×©×•×‘×” ××”×××©×œ×”
      extraInfo = await fetchCarDetails(carNum); 
  }
  // ----------------------------------------

  // --- 2. ××—×™×§×ª ×ª×•×¨ ×™×©×Ÿ (×‘××§×¨×” ×©×œ ×”×—×œ×¤×”) ---
  if (oldAppt) {
    const oldDateKey = oldAppt.date; 
    const oldDay = data[oldDateKey];

    if (oldDay && oldDay.appointments) {
      const idx = oldDay.appointments.findIndex(a =>
        String(a.carNumber).trim() === String(oldAppt.carNumber).trim() &&
        a.time === oldAppt.time &&
        a.status !== 'DELETED'
      );
      if (idx > -1) {
          oldDay.appointments.splice(idx, 1);
      }
    }
  }
  
  // --- 3. ×©××™×¨×ª ×”×ª×•×¨ ×”×—×“×© ×¢× ×”×¤×¨×˜×™× ---
  if (!data[date]) data[date] = { appointments: [] };
  if (!data[date].appointments) data[date].appointments = [];
  
  const newAppt = {
    time: time,
    first: first,
    last: last,
    phone: phone,
    carNumber: carNum,
    
    // ×›××Ÿ ×× ×—× ×• ×©×•××¨×™× ××ª ×”××™×“×¢ ×”×—×“×©:
    carModel: extraInfo.model, 
    carYear: extraInfo.year,
    
    status: "BOOKED",
    timestamp: Date.now()
  };
  
  data[date].appointments.push(newAppt);
  
  // ×©××™×¨×” ×œ×¤×™×™×¨×‘×™×™×¡
  await saveData(data);
  
  // --- 4. ×¡×™×•× ×•×ª×¦×•×’×” ---
  const s = data[date].settings || {};
  const interval = parseInt(s.range1Interval) || 15;
  
  if(typeof showSuccessModal === 'function') {
      showSuccessModal(date, time, interval, first);
  } else {
      alert("×”×ª×•×¨ ×”×•×–××Ÿ ×‘×”×¦×œ×—×”!");
      location.reload();
  }
  
  if (oldAppt) {
    const successText = document.getElementById('successText');
    if(successText) {
      successText.innerHTML += `
      <br><br>
      <span style="font-size:0.9em; color:#ff9800; border-top:1px solid #444; padding-top:5px; display:block;">
      ×”×ª×•×¨ ×”×§×•×“× ×‘×•×˜×œ.
      </span>`;
    }
  }
}

// --- 8. ×”×¦×’×ª ××¡×š ×¡×™×•× ×œ×¤×¢×•×œ×•×ª ×›×œ×œ×™×•×ª (×‘×™×˜×•×œ ×•×›×•') ---
function showPostActionScreen(titleText, color, subText) {
  document.getElementById('header-area').style.display = 'none';
  document.getElementById('main-container').style.display = 'none';
  
  const title = document.getElementById('postTitle');
  const sub = document.getElementById('postSubtitle');
  const btn = document.getElementById('btnReturn');
  
  if(title) { title.innerText = titleText; title.style.color = color; }
  if(sub) sub.innerText = subText;
  if(btn) btn.innerHTML = "âœï¸ ×—×–×¨×” ×œ××¢×¨×›×ª";
  
  const screen = document.getElementById('postBookingScreen');
  if(screen) screen.style.display = 'flex';
}
// =========================================================================

async function saveData(data) {
  try { await db.ref('appointments').set(data); }
  catch (e) { console.error("Error saving:", e); alert("×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×©×œ×š."); }
}

function initRealtimeListener() {
  const overlay = document.getElementById('loadingOverlay');
  const status = document.getElementById('connectionStatus');
  overlay.style.display = 'flex';
  status.innerText = "××¢×“×›×Ÿ × ×ª×•× ×™× ××”×©×¨×ª...";
  
  if (!db) return;
  
  // ×”××–× ×” ×œ× ×ª×•× ×™ ×”×ª×•×¨×™×
  db.ref('appointments').on('value', (snapshot) => {
    globalData = snapshot.val() || {};
    buildCalendar();
    
    // --- ×œ×•×’×™×§×ª ×¤×•×§×•×¡ ××•×˜×•××˜×™ ×œ×ª××¨×™×š ×”×¨××©×•×Ÿ ×”×¤× ×•×™ ---
    const todayKey = dateToKey(new Date());
    const sortedDates = Object.keys(globalData).sort();
    
    // ××¦×™××ª ×”×ª××¨×™×š ×”×¨××©×•×Ÿ ×©×™×© ×‘×• ×ª×•×¨×™× ×–××™× ×™× ××”×™×•× ×•×”×œ××”
    const firstAvailableDate = sortedDates.find(date => {
      return date >= todayKey && getAvailableSlots(globalData[date]).length > 0;
    });
    
    // ×× × ××¦× ×ª××¨×™×š ×›×–×” ×•×¢×“×™×™×Ÿ ×œ× × ×‘×—×¨ ×ª××¨×™×š ×™×“× ×™×ª - × ×‘×—×¨ ××•×ª×•
    if (firstAvailableDate && !selectedDate) {
      selectDate(firstAvailableDate);
    }
    // ----------------------------------------------
    
    if (selectedDate) renderAvailableSlots();
    overlay.style.display = 'none';
  }, (err) => {
    console.error("Realtime error:", err);
    status.innerText = "×©×’×™××” ×‘×¢×“×›×•×Ÿ ×‘×–××Ÿ ×××ª.";
  });
  
  // ×”××–× ×” ×œ×”×’×“×¨×•×ª ×”×›×•×ª×¨×ª
  db.ref('settings/calendarTitle').on('value', s => {
    const val = s.val();
    if(val) {
      systemCalendarTitle = val;
      const subtitleEl = document.getElementById('pageSubtitle');
      if(subtitleEl) subtitleEl.innerText = val;
    }
  });
}

try { initRealtimeListener(); } catch (e) { console.warn(e); }
setInterval(() => { if (selectedDate) { const now = new Date(); if (dateToKey(now) === selectedDate) renderAvailableSlots(); } }, 60000);
// ==========================================
// === ×˜×™×™××¨ ××™-×¤×¢×™×œ×•×ª: ×¡×’×™×¨×ª ×”×“×£ (×—×¡×™××”) ===
// ==========================================
(function() {
  let time;
  // ×–××Ÿ: 5 ×“×§×•×ª (300,000 ××™×œ×™×©× ×™×•×ª)
  const timeoutDuration = 300000;
  
  function killSession() {
    // ×¤×¢×•×œ×” ×–×• ××•×—×§×ª ××ª ×›×œ ×”×ª×•×›×Ÿ ×©×œ ×”×“×£ ×•××¦×™×’×” ××¡×š ×©×—×•×¨ ×¢× ×”×•×“×¢×”
    document.body.innerHTML = `
    <div style="
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background-color: #0f172a;
    color: white;
    font-family: sans-serif;
    text-align: center;
    direction: rtl;">
    
    <div style="font-size: 4em; margin-bottom: 20px;">ğŸ”’</div>
    <h1 style="font-size: 2em; margin-bottom: 10px;">×”××¢×¨×›×ª × ×¡×’×¨×” ×¢×§×‘ ×—×•×¡×¨ ×¤×¢×™×œ×•×ª</h1>
    <p style="font-size: 1.2em; color: #94a3b8;">×›×“×™ ×œ×”×–××™×Ÿ ×ª×•×¨ ×—×“×©, × × ×œ×”×™×›× ×¡ ××—×“×© ×“×¨×š ×”×§×™×©×•×¨.</p>
    </div>
    `;
  }
  
  function resetTimer() {
    clearTimeout(time);
    // ×× ×œ× ×ª×”×™×” ×¤×¢×™×œ×•×ª ×‘××©×š 5 ×“×§×•×ª - ×”×¤×•× ×§×¦×™×” killSession ×ª×•×¤×¢×œ
    time = setTimeout(killSession, timeoutDuration);
  }
  
  // ×¨×©×™××ª ××™×¨×•×¢×™× ×©×××¤×¡×™× ××ª ×”×˜×™×™××¨ (×›×œ ×¢×•×“ ×”××©×ª××© ×¤×¢×™×œ)
  window.onload = resetTimer;
  document.onmousemove = resetTimer;
  document.onkeypress = resetTimer;
  document.ontouchstart = resetTimer; // ×œ××¡×›×™ ××’×¢
  document.onclick = resetTimer;
  document.onscroll = resetTimer;
})();

</script>
<div id="mathVerifyModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; display:none; justify-content:center; align-items:center; flex-direction:column;">

<div style="background:#1e293b; border:1px solid #475569; padding:30px; border-radius:12px; width:90%; max-width:320px; text-align:center; box-shadow: 0 0 20px rgba(0,0,0,0.7); position:relative;">

<span onclick="document.getElementById('mathVerifyModal').style.display='none'"
style="position:absolute; top:10px; left:15px; cursor:pointer; font-size:24px; color:#94a3b8;">&times;</span>

<div style="font-size:40px; margin-bottom:10px;">ğŸ›¡ï¸</div>
<h3 style="color:#38bdf8; margin:0 0 10px 0;">×‘×“×™×§×ª ××‘×˜×—×”</h3>
<p style="color:#cbd5e1; margin-bottom:20px;">×›××” ×–×”?</p>

<div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:20px; direction:ltr;">
<span id="verifyMathQ" style="font-size:24px; font-weight:bold; color:white;"></span>
<span style="font-size:24px; color:white;">=</span>
<input type="number" id="verifyMathAns" style="width:80px; padding:8px; font-size:20px; text-align:center; border-radius:6px; border:1px solid #475569; background:#334155; color:white;" autocomplete="off">
</div>

<button onclick="submitMathVerify()" style="background:#22c55e; color:white; width:100%; padding:12px; font-size:16px; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">
××©×¨ ×•×”××©×š
</button>
</div>
</div>

<script>
// ×œ×•×’×™×§×” ×œ×”×ª×§× ×”
//let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
});

window.installPWA = async function() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    deferredPrompt = null;
  } else {
    alert("×œ×”×ª×§× ×” ×™×“× ×™×ª:\n×‘××™×™×¤×•×Ÿ: ×©×ª×£ > ×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª\n×‘×× ×“×¨×•××™×“: ×ª×¤×¨×™×˜ > ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”");
  }
};

// ×¨×™×©×•× ×”-SW
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
// === ×¤×•× ×§×¦×™×™×ª ×¢×–×¨: ××©×™×›×ª ×¤×¨×˜×™ ×¨×›×‘ (×“×’× ×•×©× ×”) ===
async function fetchCarDetails(carNumber) {
    if (!carNumber || carNumber.length < 5) return { model: '', year: '' };
    try {
        const resourceId = '053cea08-09bc-40ec-8f7a-156f0677aff3'; 
        const cleanNum = carNumber.replace(/\D/g, ''); 
        const url = `https://data.gov.il/api/3/action/datastore_search?resource_id=${resourceId}&q=${cleanNum}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.result.records.length > 0) {
            const car = data.result.records.find(r => String(r.mispar_rechev) === String(cleanNum));
            if (car) {
                return { model: car.tozeret_nm || '', year: car.shnat_yitzur || '' };
            }
        }
    } catch (e) {
        console.error("×©×’×™××” ×‘××©×™×›×ª × ×ª×•× ×™×:", e);
    }
    return { model: '', year: '' };
}
</script>
</body>
</html>
